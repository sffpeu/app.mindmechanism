rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId}/notes/{noteId} {
      // Helper functions
      function isSignedIn() {
        return request.auth != null;
      }
      
      function isOwner() {
        return request.auth.uid == userId;
      }
      
      function isValidNote() {
        let note = request.resource.data;
        return note.title is string
          && note.title.size() > 0
          && note.title.size() <= 100
          && note.content is string
          && note.content.size() <= 10000
          && note.createdAt is timestamp
          && note.updatedAt is timestamp;
      }

      // Rules
      allow read: if isSignedIn() && isOwner();
      
      allow create: if isSignedIn() 
        && isOwner()
        && isValidNote();
      
      allow update: if isSignedIn() 
        && isOwner()
        && isValidNote()
        && request.resource.data.createdAt == resource.data.createdAt;
      
      allow delete: if isSignedIn() && isOwner();
    }
  }
} 