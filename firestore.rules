rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUserOwner(userId) {
      return request.auth.uid == userId;
    }

    match /users/{userId}/notes/{noteId} {
      function isValidNote() {
        let note = request.resource.data;
        return note.title is string
          && note.title.size() > 0
          && note.title.size() <= 100
          && note.content is string
          && note.content.size() <= 10000
          && note.createdAt is timestamp
          && note.updatedAt is timestamp;
      }

      // Rules
      allow read: if isAuthenticated() && isUserOwner(userId);
      
      allow create: if isAuthenticated() 
        && isUserOwner(userId)
        && isValidNote();
      
      allow update: if isAuthenticated() 
        && isUserOwner(userId)
        && isValidNote()
        && request.resource.data.createdAt == resource.data.createdAt;
      
      allow delete: if isAuthenticated() && isUserOwner(userId);
    }

    match /timeTracking/{entryId} {
      function isValidTimeEntry() {
        let entry = request.resource.data;
        return entry.userId is string
          && entry.startTime is timestamp
          && (entry.endTime == null || entry.endTime is timestamp)
          && entry.page is string;
      }

      allow read: if isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid && isValidTimeEntry();
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /sessions/{sessionId} {
      allow read: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.user_id == request.auth.uid;
    }
  }
} 